---
title: "organ specific signatures - BRCs only"
author: "Mechthild LÃ¼tge"
date: "14 May 2020"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

## load packages
```{r libs}
suppressPackageStartupMessages({
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(SingleCellExperiment)
  library(RColorBrewer)
  library(viridis)
  library(ggsci)
  library(scater)
  library(scran)
  library(pheatmap)
  library(biomaRt)
  library(fgsea)
  library(grid)
  library(gridExtra)
  library(clusterProfiler)
  library(org.Mm.eg.db)
  library(DOSE)
  library(enrichplot)
  library(msigdbr)
  library(muscat)
  library(ggpubr)
})

```

## plotting funct
```{r avg heatmap funct}

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  ## format gene names (depends on how gene list is inputed)
  selGenes <- selGenes %>% 
      mutate(geneID = (str_split(gene, '\\.', simplify = T)[,2]))
  #selGenes <- selGenes$labelNam
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>%
    filter(geneID %in% selGenes$geneID)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colVecCond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes$geneID,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#45628f", "#F7F7F7", "#de425b"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}



```


## set dir and read input data
```{r set dir}
basedir <- here()

## read seurat objects with BRCs
seurat <- readRDS(file=paste0(basedir, "/data/folBRC_allSLO_seurat.rds"))
## seurat <-rerunSeurat3(seurat)
## saveRDS(seurat, file=paste0(basedir, "/data/folBRC_allSLO_seurat.rds"))
```


## set color Vectors
```{r color vectors}

colPal <- c("#87c5af", "#94033b", "#fc8f3b", "#2580fe", "#514e72")
names(colPal) <- c("LZFDC", "MRC", "TBRC","DZFDC","PRC2")


colorSLO <- c(viridis(3)[c(1,2)], brewer.pal(n=9, name="YlOrRd")[c(4)])
colorCond <- brewer.pal(n=3, name="Paired")[c(1,2)]
colorSLOCond <- c("#440154FF","#807DBA", "#FEB24C", "#F16913", "#21908CFF")
colorBatch <- pal_igv()(n=length(unique(seurat$batch)))
colCl <- c(rcartocolor::carto_pal(name="Safe"),pal_aaas()(8))

names(colorSLO) <- c("LN", "PP", "Spleen")
names(colorCond) <- c("naive", "immunized")
names(colorBatch) <- unique(seurat$batch)
names(colorSLOCond) <- c("LN_immunized","LN_naive", "Spleen_naive",
                         "Spleen_immunized", "PP_immunized")

```

## visualize data {.tabset}

### clustering
```{r clustering}

DimPlot(seurat, reduction = "umap", cols=colPal, group.by = "clusterLabel")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```

### SLO
```{r SLO}

DimPlot(seurat, reduction = "umap", cols=colorSLO, group.by = "SLO")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", cols=colorSLO, group.by = "SLO",
        pt.size=0.6)+
  theme_void()
```

### Batch
```{r Batch}

DimPlot(seurat, reduction = "umap", cols=colorBatch, group.by = "batch")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```

### Cond
```{r Cond}

DimPlot(seurat, reduction = "umap", cols=colorCond, group.by = "cond")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```


### SLO plus cond
```{r SLO plus cond}

DimPlot(seurat, reduction = "umap", cols=colorSLOCond,group.by="SLO_plus_cond")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


DimPlot(seurat, reduction = "umap",cols=colorSLOCond,group.by = "SLO_plus_cond",
        pt.size=0.6)+
  theme_void()
```


## SLO specific BRC gene signatures
```{r SLO specific gene signatures}

Idents(seurat) <- seurat$SLO
seurat_markers_all <- FindAllMarkers(object = seurat,
                                     only.pos = TRUE, min.pct = 0.25,
                                     logfc.threshold = 0.25,
                                     test.use = "wilcox")

write.table(seurat_markers_all,
            file=paste0(basedir, "/data/allBRC_SLOsignature.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")




```

### vis top marker {.tabset}
#### across SLO
```{r vis top marker SLO, fig.height=9, fig.width=5}
selGenes <- seurat_markers_all %>% group_by(cluster) %>% 
  top_n(-15, p_val_adj) %>% 
  top_n(15, avg_log2FC)

Idents(seurat) <- seurat$SLO_plus_clusterlabel

gapC <- c((length(unique(seurat$SLO_plus_clusterlabel))/3),
          2*(length(unique(seurat$SLO_plus_clusterlabel))/3))
gapR <- c(15,30)

pOut <- avgHeatmap(seurat = seurat, selGenes = selGenes,
                  colVecIdent = colorSLO, 
                  ordVec=levels(seurat),
                  gapVecR=gapR, gapVecC=gapC,cc=F,
                  cr=F, condCol=T, colVecCond = colPal)

```


## SLO specific gene signatures per subset {.tabset}
```{r SLO specific gene signatures per subset}
seurat$clusterGrp <- seurat$clusterLabel

Idents(seurat) <- seurat$SLO
cwDEgenes <- lapply(unique(seurat$clusterGrp), function(grp){
  grpSub <- unique(seurat$clusterGrp)[which(unique(seurat$clusterGrp)==grp)]
  seuratSub <- subset(seurat, clusterGrp == grpSub)
  DEgenes <-FindAllMarkers(seuratSub, only.pos=T, logfc.threshold = 0.25,
                           min.pct = 0.1)
  DEgenes <- DEgenes %>% filter(p_val_adj<0.01)
})

names(cwDEgenes) <- unique(seurat$clusterGrp)

```



## SLO marker overlap between grps 
```{r SLO marker overlap, fig.height=21, fig.width=9}

grpVec <- unique(seurat$clusterGrp)
orgVec <- unique(seurat$SLO)

orgMarker <- lapply(orgVec, 
  function(slo){
    TBRCgenes <- cwDEgenes[["TBRC"]] %>% filter(cluster==slo)
    MRCgenes <- cwDEgenes[["MRC"]] %>% filter(cluster==slo)
    LZFDCgenes <- cwDEgenes[["LZFDC"]] %>% filter(cluster==slo)
    DZFDCgenes <- cwDEgenes[["DZFDC"]] %>% filter(cluster==slo)
    PRC2genes <- cwDEgenes[["PRC2"]] %>% filter(cluster==slo)
    all <- intersect(intersect(intersect(intersect(TBRCgenes$gene, MRCgenes$gene),
                               LZFDCgenes$gene), DZFDCgenes$gene), PRC2genes$gene)
  }
)

names(orgMarker) <- orgVec
## orgMarker = DE genes in all shared folicular BRC subsets
## (adj_pVal < 0.01, min_pct = 0.1, log_FC > 0.25)

orgMarker <- lapply(orgVec, 
                    function(slo){
                      GrpGeneList <- lapply(grpVec, function(grp){
                        genesGrp <- cwDEgenes[[grp]] %>% filter(cluster==slo)
                        })
                      SLOgenes <- data.frame(do.call("rbind", GrpGeneList)) %>% 
                        group_by(gene) %>% summarise(cnt=n()) %>%
                        filter(cnt>=(length(grpVec)-1))
                      out <- SLOgenes$gene
                      }
                    )

names(orgMarker) <- orgVec

```

## vis all marker conserved across all subsets {.tabset}
### LN
```{r vis all conserved marker LN, fig.height=16, fig.width=12}

seurat$label_plus_organ_plus_cond <- factor(paste0(seurat$SLO_plus_clusterlabel, "_",
                                            seurat$cond))
Idents(seurat) <- seurat$label_plus_organ_plus_cond
selGenes <- data.frame(gene=orgMarker[["LN"]])
allGenes <- data.frame(gene=rownames(seurat)) %>%
  mutate(geneNam=gsub("^.*\\.", "", gene))
selGenesDat <- selGenes %>% left_join(., allGenes, by=c("gene"))

seurat$label_plus_cond <- paste0(seurat$clusterLabel, "_", seurat$cond)
colSel <- c(rep(colorCond[["naive"]], 5), rep(colorCond[["immunized"]], 5))
names(colSel) <- unique(seurat$label_plus_cond)
pOut <- avgHeatmap(seurat = seurat, selGenes = selGenesDat,
                  colVecIdent = colorSLO, 
                  ordVec=levels(seurat),
                  gapVecC=c(10,15),cc=F,
                  cr=T,condCol=T, colVecCond=colSel)
```

### Spleen
```{r vis all conserved marker spleen, fig.height=12, fig.width=12}

selGenes <- data.frame(gene=orgMarker[["Spleen"]])
allGenes <- data.frame(gene=rownames(seurat)) %>%
  mutate(geneNam=gsub("^.*\\.", "", gene))
selGenesDat <- selGenes %>% left_join(., allGenes, by=c("gene")) %>% 
  filter(nchar(geneNam)>1)

pOut <- avgHeatmap(seurat = seurat, selGenes = selGenesDat,
                  colVecIdent = colorSLO, 
                  ordVec=levels(seurat),
                  gapVecC=c(10,15),cc=F,
                  cr=T,condCol=T, colVecCond=colSel)
```

### PP
```{r vis all conserved marker PP, fig.height=8, fig.width=12}

selGenes <- data.frame(gene=orgMarker[["PP"]])
allGenes <- data.frame(gene=rownames(seurat)) %>%
  mutate(geneNam=gsub("^.*\\.", "", gene))
selGenesDat <- selGenes %>% left_join(., allGenes, by=c("gene"))

pOut <- avgHeatmap(seurat = seurat, selGenes = selGenesDat,
                  colVecIdent = colorSLO, 
                  ordVec=levels(seurat),
                  gapVecC=c(10,15),cc=F,
                  cr=T,condCol=T, colVecCond=colSel)
```

### sc heatmap SLO specific marker
```{r sc heatmap slo specific, fig.height=8, fig.width=14}
selFeatures <- data.frame(ensID=c(orgMarker$LN, orgMarker$PP, 
                                  orgMarker$Spleen)) %>% 
  mutate(label=gsub("^.*\\.", "", ensID))
DoHeatmap(seurat, features = selFeatures$ensID, group.by = "SLO", 
          group.colors = colorSLO, slot = 'scale.data', label = F,
          disp.min = -0.5, disp.max = 2) +
  scale_fill_continuous(type = "viridis") +
  scale_y_discrete(breaks=selFeatures$ensID, labels=selFeatures$label)


DoHeatmap(seurat, features = selFeatures$ensID, group.by = "SLO", 
          group.colors = colorSLO, slot = 'scale.data', label = F,
          disp.min = -1, disp.max = 1.5, draw.lines = F) +
  scale_fill_gradientn(colors=colorRampPalette(c("#45628f", "#F7F7F7", "#de425b"))(30)) +
  scale_y_discrete(breaks=selFeatures$ensID, labels=selFeatures$label)

```


## GSEA clusterProfiler {.tabset}
### LN
```{r GSEA clusterprofiler, fig.height=6, fig.width=12}
orgMarkerDat <- data.frame(do.call("cbind", orgMarker)) %>% 
  gather(., SLO, gene, LN:Spleen) %>% mutate(EnsID = gsub("\\..*$", "", gene))

write.table(orgMarkerDat,
            file = paste0(basedir, "/data/GSEA/SLOspecificGenes.txt"),
            sep="\t", quote = F, row.names = F, col.names = T)

orgMarkerDatLN <- orgMarkerDat %>% filter(SLO == "LN")
egoLN <- enrichGO(gene         = unique(orgMarkerDatLN$EnsID),
                OrgDb         = org.Mm.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
egoLN <- setReadable(egoLN, OrgDb = org.Mm.eg.db)
dotplot(egoLN, showCategory=30)
cnetplot(egoLN, node_label="all") 



```


### PP
```{r GSEA clusterprofiler PP, fig.height=8, fig.width=14}

orgMarkerDatPP <- orgMarkerDat %>% filter(SLO == "PP")
egoPP <- enrichGO(gene         = unique(orgMarkerDatPP$EnsID),
                OrgDb         = org.Mm.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.5,
                qvalueCutoff  = 0.5)
egoPP <- setReadable(egoPP, OrgDb = org.Mm.eg.db)
dotplot(egoPP, showCategory=30)
cnetplot(egoPP, node_label="all") 


```

### Spleen
```{r GSEA clusterprofiler Spleen, fig.height=8, fig.width=12}
 
orgMarkerDatSP <- orgMarkerDat %>% filter(SLO == "Spleen")
egoSP <- enrichGO(gene         = unique(orgMarkerDatSP$EnsID),
                OrgDb         = org.Mm.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
egoSP <- setReadable(egoSP, OrgDb = org.Mm.eg.db)
dotplot(egoSP, showCategory=30)
cnetplot(egoSP, node_label="all") 

goplot(egoSP)
egoSP2 <- pairwise_termsim(egoSP)
treeplot(egoSP2)
emapplot(egoSP2)
upsetplot(egoSP2)
egoSP2 <- simplify(egoSP2, cutoff=0.7, by="p.adjust", select_fun=min)
emapplot(egoSP2)
treeplot(egoSP2)
dotplot(egoSP, showCategory=30)

```


### vis summary all {.tabset}
#### Dotplot 
```{r vis summary, fig.height=6, fig.width=7}
selLN <- c("GO:0003002", "GO:0007389", "GO:0010464","GO:1901342","GO:0009611")
selPW_LN <- egoLN@result %>% filter(qvalue<0.05) %>% 
  filter(ID %in% selLN) %>%
  mutate(IDfac= factor(ID, levels = selLN)) %>% 
  arrange(., IDfac) %>% 
  dplyr::select(ID, Description, GeneRatio, qvalue, Count) %>% 
  mutate(SLO="LN") %>% 
  arrange(., Count)

selSP <- c("GO:0019882", "GO:0048536", "GO:1903522", "GO:0045766","GO:0055072")
selPW_SP <- egoSP@result %>% filter(qvalue<0.05) %>% 
  filter(ID %in% selSP) %>% 
  mutate(IDfac= factor(ID, levels = selSP)) %>% 
  arrange(., IDfac) %>% 
  dplyr::select(ID, Description, GeneRatio, qvalue, Count) %>% 
  mutate(SLO="Spleen") %>% 
  arrange(., Count)

selPP <- c("GO:0071604", "GO:0042573","GO:0006694","GO:0030510", "GO:0048562")
selPW_PP <- egoPP@result %>% filter(qvalue<1) %>% 
  filter(ID %in% selPP) %>% 
  mutate(IDfac= factor(ID, levels = selPP)) %>% 
  arrange(., IDfac) %>% 
  dplyr::select(ID, Description, GeneRatio, qvalue, Count) %>% 
  mutate(SLO="PP") %>% 
  arrange(., Count)


selPW_all <- rbind(selPW_PP, selPW_SP, selPW_LN) %>%
  mutate(nom=as.numeric(gsub("\\/.*", "", GeneRatio))) %>% 
  mutate(denom=as.numeric(gsub(".*\\/", "", GeneRatio))) %>% 
  mutate(geneRatio=nom/denom) %>% 
  mutate(one_minPadjust=(1-qvalue))
 
level_order <- unique(selPW_all$Description)
ggplot(selPW_all, aes(x=factor(Description, level= level_order), y=geneRatio)) + 
  geom_point(aes(col=SLO, size=Count, alpha=one_minPadjust)) + 
  scale_color_manual(values = colorSLO)+
  scale_alpha_continuous(range = c(0.5,1), name="qvalue",
                         labels=c(0.04, 0.03, 0.02, 0.01),
                         breaks = c(0.96, 0.97, 0.98, 0.99)) +
  scale_size_continuous(range = c(3,6), labels = c(2,4,6,8),
                        breaks = c(2,4,6,8)) +
  geom_segment(aes(x=Description, 
                   xend=Description, 
                   y=min(geneRatio), 
                   yend=max(geneRatio)), 
               linetype="dashed", 
               size=0.1) +   # Draw dashed lines
  coord_flip() +
  theme_minimal() +
  theme(panel.border = element_rect(fill = NA), 
        panel.grid = element_blank(), axis.title.y = element_blank())
```

#### Network 
```{r network}
selGOLN <- c("GO:0009611", "GO:0003002", "GO:0010464", "GO:1901342")
selGOPP <- c("GO:0042573","GO:0006694", "GO:0030510", "GO:0048562")
selGOSP <- c("GO:0019882", "GO:1903522", "GO:0055072", "GO:0048536")
selGOall <- c(selGOLN, selGOPP, selGOSP)
  
egoLN@result <- egoLN@result %>% filter(ID %in% selGOLN) %>% mutate(SLO = "LN")
cnetplot(egoLN, node_label="all", 
        color_category="#440154FF", 
        color_gene="#a473b0",
        cex_label_gene = 0.5) 

egoPP@result <- egoPP@result %>% filter(ID %in% selGOPP) %>% mutate(SLO = "PP")
cnetplot(egoPP, node_label="all", 
        color_category="#21908CFF", 
        color_gene="#7cbab8",
        cex_label_gene = 0.5) 

egoSP@result <- egoSP@result %>% filter(ID %in% selGOSP) %>%
  mutate(SLO = "Spleen")
cnetplot(egoSP, node_label="all", 
        color_category="#FEB24C", 
        color_gene="#e5c9a2",
        cex_label_gene = 0.5) 

```


#### barplot
```{r}

egoResAll <- rbind(egoLN@result, egoPP@result, egoSP@result) %>%
  mutate(qscore=-log(p.adjust, base=10)) 
p <- ggbarplot(egoResAll, x = "Description", y = "qscore",
          fill = "SLO",               
          color = "SLO",            
          palette = colorSLO,            
          sort.val = "asc",           
          sort.by.groups = TRUE      
          #x.text.angle = 90           
          ) + 
  rotate()
p


```


#### compare cluster
```{r compare cluster}

orgMarkerList <- lapply(orgVec, function(slo){
  selMarker <- orgMarkerDat %>% filter(SLO == slo)
  out <- selMarker$EnsID
})
names(orgMarkerList) <- orgVec

ck <- compareCluster(geneCluster = orgMarkerList,
                     fun = enrichGO,
                     OrgDb = org.Mm.eg.db,
                     keyType = 'ENSEMBL',
                     ont = "BP",
                     pvalueCutoff  = 0.1,
                     qvalueCutoff  = 0.1
)
ck <- setReadable(ck, OrgDb = org.Mm.eg.db)
ck@compareClusterResult <- ck@compareClusterResult %>% filter(ID %in% selGOall)


cnetplot(ck) 

```


## organ specific genes dotplot
```{r SLO sepcific genes, fig.height=8, fig.width=7}

selMarkerAll <- read_tsv(paste0(basedir,"/data/SLOspecificSelMarker.txt"))


genes <- data.frame(ensID=rownames(seurat)) %>%
  mutate(gene=gsub("^.*\\.", "", ensID))
selGenes <- selMarkerAll %>% 
  left_join(., genes, by=c("geneNam"="gene"))

Idents(seurat) <- seurat$SLO_plus_clusterlabel
clusterDat <- data.frame(ident=levels(seurat)) %>%
  mutate(SLO=gsub("_.*$", "", ident)) %>% 
  mutate(namFull=paste0(ident, "_", SLO)) %>%
  mutate(label= gsub("^.*_", "", ident))


levels(seurat) <- levels(seurat)[c(4,2,5,1,3,8,10,9,7,6,15,13,12,11,14)]

DotPlot(seurat, features = selGenes$ensID, split.by = "SLO",
        cols = colorSLO, col.max = 6) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks=selGenes$ensID, labels=selGenes$geneNam) +
  scale_y_discrete(breaks=clusterDat$namFull, labels=clusterDat$ident) +
  xlab("") + ylab("") + theme(legend.position = "none")


DotPlot(seurat, features = selGenes$ensID, split.by = "SLO",
        cols = colorSLO, col.max = 6) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(breaks=selGenes$ensID, labels=selGenes$geneNam) +
  scale_y_discrete(breaks=clusterDat$namFull, labels=clusterDat$ident) +
  xlab("") + ylab("") 

```

## MDS plot 

```{r mds plot, fig.height=3, fig.width=4}

sce <- as.SingleCellExperiment(seurat)
sce <- prepSCE(sce, 
    kid = "SLO", 
    gid = "cond",   
    sid = "dataset",  
    drop = F)       

pb <- aggregateData(sce,
    assay = "counts", fun = "sum",
    by = c("cluster_id", "sample_id"))

pb_mds <- pbMDS(pb) +
  scale_color_manual(values = colorSLO)
pb_mds

pb_mds + theme_void()
```




## session info
```{r session info}
sessionInfo()
date()
```

